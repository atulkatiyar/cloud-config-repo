import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import static org.mockito.Mockito.*;

class LogLevelStartUpAgentTest {

    @BeforeEach
    void setUp() {
        System.setProperty("log.level.controller.host", "https://mocked-url.com");
        System.setProperty("javax.net.ssl.trustStore", "mocked-truststore.jks");
        System.setProperty("javax.net.ssl.trustStorePassword", "changeit");
    }

    @Test
    void testFetchUpdatedLog4jXml_Success() throws Exception {
        HttpURLConnection connectionMock = mock(HttpURLConnection.class);
        InputStream inputStreamMock = new ByteArrayInputStream("<xml></xml>".getBytes());

        when(connectionMock.getResponseCode()).thenReturn(200);
        when(connectionMock.getInputStream()).thenReturn(inputStreamMock);

        // Instead of mocking URL, use a real URL and spy on it
        URL realUrl = new URL("https://mocked-url.com/app/log4j2.xml");
        URL spyUrl = spy(realUrl);

        when(spyUrl.openConnection()).thenReturn(connectionMock);

        // Use reflection to inject the mocked URL into the method
        Mockito.doReturn(connectionMock).when(spyUrl).openConnection();

        LogLevelStartUpAgent.fetchUpdatedLog4jXml();

        verify(connectionMock, times(1)).getResponseCode();
        verify(connectionMock, times(1)).getInputStream();
    }
