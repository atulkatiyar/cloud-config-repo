package com.lseg.ipps.solutions.tpl.controller;

import com.lseg.ipps.solutions.tpl.cache.Log4JCache;
import com.lseg.ipps.solutions.tpl.model.Timer;
import com.lseg.ipps.solutions.tpl.model.TimerResponse;
import com.lseg.ipps.solutions.tpl.service.LoggingLevelService;
import freemarker.template.Configuration;
import freemarker.template.Template;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockedStatic;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.ui.freemarker.FreeMarkerConfigurationFactoryBean;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class LogConfigControllerTest {

    @Mock
    private LoggingLevelService loggingLevelService;
    
    @Mock
    private FreeMarkerConfigurationFactoryBean freemarkerConfig;
    
    @Mock
    private Configuration configuration;
    
    @Mock
    private Template template;
    
    @InjectMocks
    private LogConfigController controller;
    
    private Log4JCache log4JCache;

    @BeforeEach
    void setUp() {
        log4JCache = mock(Log4JCache.class);
    }

    @Test
    void showDashboard_ReturnsCorrectView() {
        String result = controller.showDashboard();
        assertEquals("log-level-controller", result);
    }

    @Test
    void generateLog4j_CreatesNewConfiguration() {
        try (MockedStatic<Log4JCache> mockedStatic = mockStatic(Log4JCache.class)) {
            String rootLevel = "INFO";
            String packageName = "com.example";
            String packageLevel = "DEBUG";
            String timer = "60";
            
            mockedStatic.when(() -> Log4JCache.getInstance(any(TimeUnit.class), anyLong()))
                    .thenReturn(log4JCache);
            when(loggingLevelService.getRemainingTime()).thenReturn(60000L);
            when(log4JCache.get(LogConfigController.LOG4J_CONFIG_CACHE_KEY))
                    .thenReturn(new HashMap<String, Object>());
            
            ResponseEntity<TimerResponse> response = controller.generateLog4j(
                rootLevel, packageName, packageLevel, timer
            );
            
            assertNotNull(response);
            assertEquals(HttpStatus.OK, response.getStatusCode());
            verify(log4JCache, times(2)).put(anyString(), any());
            verify(loggingLevelService).getRemainingTime();
        }
    }

    @Test
    void getLog4jData_WhenCacheIsNull_ReturnsDefaultData() {
        try (MockedStatic<Log4JCache> mockedStatic = mockStatic(Log4JCache.class)) {
            mockedStatic.when(Log4JCache::checkIfLog4JCacheIsNull).thenReturn(true);
            
            ResponseEntity<TimerResponse> response = controller.getLog4jData();
            
            assertNotNull(response);
            assertEquals(HttpStatus.OK, response.getStatusCode());
            TimerResponse timerResponse = response.getBody();
            assertNotNull(timerResponse);
            assertEquals(0, timerResponse.remainingTime());
            assertEquals("WARN", timerResponse.data().get("rootLevel"));
        }
    }

    @Test
    void clearExistingLogging_WhenCacheExists_ClearsCache() {
        try (MockedStatic<Log4JCache> mockedStatic = mockStatic(Log4JCache.class)) {
            mockedStatic.when(Log4JCache::checkIfLog4JCacheIsNull).thenReturn(false);
            mockedStatic.when(() -> Log4JCache.getInstance(any(TimeUnit.class), anyLong()))
                    .thenReturn(log4JCache);
            
            ResponseEntity<Object> response = controller.clearExistingLogging();
            
            assertEquals(HttpStatus.NO_CONTENT, response.getStatusCode());
            verify(log4JCache).clearAll(LogConfigController.LOG4J_CONFIG_CACHE_KEY);
        }
    }

    @Test
    void getRemainingTime_ReturnsCorrectResponse() {
        when(loggingLevelService.getRemainingTime()).thenReturn(5000L);
        
        ResponseEntity<TimerResponse> response = controller.getRemainingTime();
        
        assertNotNull(response);
        assertEquals(HttpStatus.OK, response.getStatusCode());
        TimerResponse timerResponse = response.getBody();
        assertNotNull(timerResponse);
        assertEquals(5000L, timerResponse.remainingTime());
    }

    @Test
    void generateLog4jXml_WithDefaultConfig_ReturnsXmlContent() throws Exception {
        try (MockedStatic<Log4JCache> mockedStatic = mockStatic(Log4JCache.class)) {
            mockedStatic.when(Log4JCache::checkIfLog4JCacheIsNull).thenReturn(true);
            when(freemarkerConfig.createConfiguration()).thenReturn(configuration);
            when(configuration.getTemplate(anyString())).thenReturn(template);
            
            ResponseEntity<String> response = controller.generateLog4jXml();
            
            assertNotNull(response);
            assertEquals(HttpStatus.OK, response.getStatusCode());
        }
    }
}
