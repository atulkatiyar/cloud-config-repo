stages:
  - backup
  - share
  - copy
  - restore

backup_aurora:
  stage: backup
  script:
    - export SNAPSHOT_ID="aurora-cluster-snapshot-$(date +%Y%m%d%H%M%S)"
    - aws configure set aws_access_key_id $AWS_SOURCE_ACCESS_KEY
    - aws configure set aws_secret_access_key $AWS_SOURCE_SECRET_KEY
    - aws rds create-db-cluster-snapshot --db-cluster-snapshot-identifier $SNAPSHOT_ID --db-cluster-identifier my-aurora-cluster
  only:
    - main

share_snapshot:
  stage: share
  script:
    - export SNAPSHOT_ID="aurora-cluster-snapshot-$(date +%Y%m%d%H%M%S)"
    - aws rds modify-db-cluster-snapshot-attribute --db-cluster-snapshot-identifier $SNAPSHOT_ID --attribute-name restore --values-to-add $TARGET_AWS_ACCOUNT_ID
  only:
    - main

copy_snapshot:
  stage: copy
  script:
    - export SNAPSHOT_ID="aurora-cluster-snapshot-$(date +%Y%m%d%H%M%S)"
    - export TARGET_SNAPSHOT_ID="copied-aurora-cluster-snapshot"
    - aws configure set aws_access_key_id $AWS_TARGET_ACCESS_KEY
    - aws configure set aws_secret_access_key $AWS_TARGET_SECRET_KEY
    - aws rds copy-db-cluster-snapshot --source-db-cluster-snapshot-identifier arn:aws:rds:$AWS_REGION:$SOURCE_AWS_ACCOUNT_ID:cluster-snapshot:$SNAPSHOT_ID --target-db-cluster-snapshot-identifier $TARGET_SNAPSHOT_ID --kms-key-id arn:aws:kms:$AWS_REGION:$TARGET_AWS_ACCOUNT_ID:key/$TARGET_KMS_KEY_ID
  only:
    - main

restore_aurora:
  stage: restore
  script:
    - aws configure set aws_access_key_id $AWS_TARGET_ACCESS_KEY
    - aws configure set aws_secret_access_key $AWS_TARGET_SECRET_KEY
    - aws rds restore-db-cluster-from-snapshot --db-cluster-identifier restored-aurora-cluster --snapshot-identifier copied-aurora-cluster-snapshot --engine aurora-mysql
  only:
    - main
